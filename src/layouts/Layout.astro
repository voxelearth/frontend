---
import '~/css/base.css'
import "~/styles/tailwind.css";
import { ClientRouter } from "astro:transitions";
import Header from "~/components/Header.astro";
import Footer from "~/components/Footer.astro";
import {
	siteLang,
	themeColor,
	siteName,
	siteDescription,
	siteDomain,
	socialPreviewImage,
	twitterHandle,
} from "~/data/config";

const { pageTitle, title, description } = Astro.props;
const requestedUrl = Astro.url ?? Astro.site ?? new URL(`https://${siteDomain}`);
const siteOrigin = requestedUrl.origin;
const canonicalUrl = Astro.url?.toString() ?? requestedUrl.toString();
const resolvedTitle = pageTitle ?? `${title ?? siteName} | ${siteName}`;
const shareTitle = resolvedTitle;
const metaDescription = description ?? siteDescription;
const metaKeywords =
	"Voxel Earth, Google Photorealistic 3D Tiles, Minecraft server, voxel pipeline, photogrammetry, GPU voxelization, geospatial streaming";
const metaAuthor = "Voxel Earth Team";
const ogImage = new URL(socialPreviewImage, siteOrigin).href;
---

<!doctype html>
<html lang={siteLang}>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content={themeColor} />
		<meta name="description" content={metaDescription} />
		<meta name="keywords" content={metaKeywords} />
		<meta name="author" content={metaAuthor} />
		<meta name="robots" content="index,follow" />
		<meta name="googlebot" content="index,follow" />
		<link rel="author" href="humans.txt" />
		<link rel="stylesheet" href="/css/minecraft.css">
		<link rel="canonical" href={canonicalUrl} />

		<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
		<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png" />
		<link rel="shortcut icon" href="/icons/favicon.ico" />
		<link rel="manifest" href="/icons/site.webmanifest" />

		<meta name="msapplication-TileColor" content="#ffffff" />

		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:type" content="website" />
		<meta property="og:title" content={shareTitle} />
		<meta property="og:description" content={metaDescription} />
		<meta property="og:image" content={ogImage} />
		<meta property="og:image:secure_url" content={ogImage} />
		<meta property="og:image:type" content="image/jpeg" />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:image:alt" content="Voxel Earth cover art" />
		<meta property="og:site_name" content={siteName} />
		<meta property="og:locale" content={siteLang} />
		<meta name="astro-view-transitions-enabled" content="false" />

		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={canonicalUrl} />
		<meta name="twitter:title" content={shareTitle} />
		<meta name="twitter:description" content={metaDescription} />
		<meta name="twitter:image" content={ogImage} />
		<meta name="twitter:image:alt" content="Voxel Earth cover art" />
		<meta name="twitter:site" content={twitterHandle} />
		<meta name="twitter:creator" content={twitterHandle} />
		<script is:inline>
			{`
        (function() {
          var originalMatchMedia = window.matchMedia;
          window.matchMedia = function(query) {
            if (typeof query === 'string' && query.includes('prefers-reduced-motion')) {
              return { matches: false, media: query, addListener: function(){}, removeListener: function(){} };
            }
            return originalMatchMedia.call(window, query);
          };
        })();
      `}
		</script>
		<title>{resolvedTitle}</title>
		<ClientRouter />
		<script type="module">
			{`
        import { navigate } from 'astro:transitions/client';

        const canHandle = (event) => {
          if (event.defaultPrevented) return false;
          if (event.button !== 0) return false;
          if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return false;
          const anchor = event.target.closest('a[data-view-transition]');
          if (!anchor) return false;
          if (anchor.target && anchor.target !== '_self') return false;
          if (anchor.hasAttribute('download')) return false;
          const url = new URL(anchor.href, window.location.origin);
          if (url.origin !== window.location.origin) return false;
          return anchor;
        };

        document.addEventListener('click', async (event) => {
          const anchor = canHandle(event);
          if (!anchor) return;
          event.preventDefault();
          await navigate(anchor.href, { history: 'push' });
        });
      `}
		</script>
	</head>
	<body>
		<Header />
		<main>
			<slot />
		</main>
		<Footer />
		<slot name="scripts" />
	</body>
</html>
